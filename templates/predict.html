<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
{% extends "base.html" %}

{% block title %}Predict Curve Progression - Scoliosis Prediction System{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4 text-center mb-5">
                <i class="fas fa-chart-line me-3"></i>
                Predict Curve Progression
            </h1>
        </div>
    </div>
    
    <div class="row">
        <!-- Input Form -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-injured me-2"></i>
                        Patient Information
                    </h5>
                </div>
                <div class="card-body">
                    <form id="predictionForm">
                        <div class="mb-3">
                            <label for="age" class="form-label">Age (years)</label>
                            <input type="number" class="form-control" id="age" min="10" max="18" step="0.1" value="13.0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sex" class="form-label">Sex</label>
                            <select class="form-control" id="sex" required>
                                <option value="">Select sex</option>
                                <option value="Female">Female</option>
                                <option value="Male">Male</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="risserSign" class="form-label">Risser Sign</label>
                            <select class="form-control" id="risserSign" required>
                                <option value="">Select Risser sign</option>
                                <option value="0">0 (No ossification)</option>
                                <option value="1">1 (25% ossification)</option>
                                <option value="2">2 (50% ossification)</option>
                                <option value="3">3 (75% ossification)</option>
                                <option value="4">4 (100% ossification)</option>
                                <option value="5">5 (Fusion complete)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="bmi" class="form-label">BMI (kg/m²)</label>
                            <input type="number" class="form-control" id="bmi" min="15" max="35" step="0.1" value="20.0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="initialCobb" class="form-label">Initial Cobb Angle (degrees)</label>
                            <input type="number" class="form-control" id="initialCobb" min="10" max="60" step="0.1" value="25.0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="curvePattern" class="form-label">Curve Pattern</label>
                            <select class="form-control" id="curvePattern" required>
                                <option value="">Select curve pattern</option>
                                <option value="Right thoracic">Right thoracic</option>
                                <option value="Left thoracic">Left thoracic</option>
                                <option value="Thoracolumbar">Thoracolumbar</option>
                                <option value="Double major">Double major</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="flexibility" class="form-label">Curve Flexibility (%)</label>
                            <input type="number" class="form-control" id="flexibility" min="20" max="90" step="1" value="65" required>
                            <div class="form-text">Percentage correction on bending films</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-brain me-2"></i>
                            Predict Progression
                        </button>
                    </form>
                    
                    <!-- Loading indicator -->
                    <div id="loading" class="loading text-center mt-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing patient data...</p>
                    </div>
                </div>
            </div>
            
            <!-- Risk Factors Info -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Risk Factors
                    </h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        <p><strong>High Risk Factors:</strong></p>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-exclamation-triangle text-warning me-1"></i> Age < 13 years</li>
                            <li><i class="fas fa-exclamation-triangle text-warning me-1"></i> Female sex</li>
                            <li><i class="fas fa-exclamation-triangle text-warning me-1"></i> Risser sign ≤ 2</li>
                            <li><i class="fas fa-exclamation-triangle text-warning me-1"></i> Initial Cobb > 25°</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Panel -->
        <div class="col-lg-8">
            <div id="resultsPanel" style="display: none;">
                <!-- Prediction Summary -->
                <div class="card mb-4 result-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Prediction Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="predictionSummary">
                            <!-- Prediction summary will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Predictions -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Timeline Predictions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Timepoint</th>
                                        <th>Predicted Cobb Angle</th>
                                        <th>Progression from Baseline</th>
                                        <th>Clinical Significance</th>
                                    </tr>
                                </thead>
                                <tbody id="timelineTable">
                                    <!-- Timeline data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Visualization -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            Interactive Progression Visualization
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="visualizationContainer" style="display: none;">
                            <div id="predictionPlotlyChart" style="height: 500px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Treatment Recommendations -->
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-stethoscope me-2"></i>
                            Clinical Recommendations
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recommendations">
                            <!-- Recommendations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPrediction = null;
let currentPatientData = null;

document.getElementById('predictionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Collect form data
    const patientData = {
        age: parseFloat(document.getElementById('age').value),
        sex: document.getElementById('sex').value,
        risser_sign: parseInt(document.getElementById('risserSign').value),
        bmi: parseFloat(document.getElementById('bmi').value),
        initial_cobb: parseFloat(document.getElementById('initialCobb').value),
        curve_pattern: document.getElementById('curvePattern').value,
        flexibility: parseFloat(document.getElementById('flexibility').value)
    };
    
    currentPatientData = patientData;
    
    // Show loading
    showLoading('loading');
    document.getElementById('resultsPanel').style.display = 'none';
    
    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(patientData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentPrediction = result.prediction;
            displayPredictionResults(result.prediction, patientData);
            generateVisualization();
            showAlert('Prediction completed successfully!', 'success');
        } else {
            showAlert('Error making prediction: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        hideLoading('loading');
    }
});

function displayPredictionResults(prediction, patientData) {
    // Display prediction summary
    const summaryDiv = document.getElementById('predictionSummary');
    summaryDiv.innerHTML = `
        <div class="col-md-3">
            <div class="text-center">
                <h3 class="text-primary">${prediction.risk_score}</h3>
                <small class="text-muted">Risk Score</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h3 class="${getRiskClass(prediction.risk_level)}">${prediction.risk_level}</h3>
                <small class="text-muted">Risk Level</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h3 class="text-info">${(prediction.progression_probability * 100).toFixed(0)}%</h3>
                <small class="text-muted">Progression Probability</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h3 class="text-secondary">${prediction.total_progression}°</h3>
                <small class="text-muted">Total Progression (24m)</small>
            </div>
        </div>
    `;
    
    // Display timeline predictions
    const timelineTable = document.getElementById('timelineTable');
    const timepoints = [
        { time: '6 months', cobb: prediction.predicted_cobb_6m },
        { time: '12 months', cobb: prediction.predicted_cobb_12m },
        { time: '24 months', cobb: prediction.predicted_cobb_24m }
    ];
    
    timelineTable.innerHTML = '';
    timepoints.forEach(tp => {
        const progression = tp.cobb - patientData.initial_cobb;
        const significance = getProgressionSignificance(progression);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${tp.time}</strong></td>
            <td>${tp.cobb}°</td>
            <td>${progression > 0 ? '+' : ''}${progression.toFixed(1)}°</td>
            <td>${significance}</td>
        `;
        timelineTable.appendChild(row);
    });
    
    // Display recommendations
    const recommendationsDiv = document.getElementById('recommendations');
    recommendationsDiv.innerHTML = `
        <div class="alert alert-info">
            <h6><i class="fas fa-lightbulb me-2"></i>Primary Recommendation:</h6>
            <p class="mb-2">${prediction.recommendation}</p>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-calendar-check me-2"></i>Follow-up Schedule:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-clock me-1"></i> ${getFollowupSchedule(prediction.risk_level)}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Monitoring Points:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-eye me-1"></i> ${getMonitoringPoints(prediction)}</li>
                </ul>
            </div>
        </div>
    `;
    
    // Show results panel
    document.getElementById('resultsPanel').style.display = 'block';
}

async function generateVisualization() {
    if (!currentPrediction || !currentPatientData) return;
    
    try {
        const response = await fetch('/api/visualize_prediction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prediction: currentPrediction,
                patient_data: currentPatientData
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Create interactive Plotly chart
            const plotData = JSON.parse(result.plot_json);
            Plotly.newPlot('predictionPlotlyChart', plotData.data, plotData.layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            });
            
            document.getElementById('visualizationContainer').style.display = 'block';
        }
    } catch (error) {
        console.error('Error generating visualization:', error);
    }
}

function getRiskClass(riskLevel) {
    const classes = {
        'High': 'text-danger',
        'Moderate': 'text-warning',
        'Low': 'text-success'
    };
    return classes[riskLevel] || 'text-secondary';
}

function getProgressionSignificance(progression) {
    if (progression > 10) {
        return '<span class="badge bg-danger">Significant progression</span>';
    } else if (progression > 5) {
        return '<span class="badge bg-warning">Moderate progression</span>';
    } else if (progression > 0) {
        return '<span class="badge bg-info">Mild progression</span>';
    } else {
        return '<span class="badge bg-success">Stable</span>';
    }
}

function getFollowupSchedule(riskLevel) {
    const schedules = {
        'High': 'Every 3-4 months',
        'Moderate': 'Every 4-6 months',
        'Low': 'Every 6-12 months'
    };
    return schedules[riskLevel] || 'Every 6 months';
}

function getMonitoringPoints(prediction) {
    if (prediction.predicted_cobb_24m > 45) {
        return 'Monitor for surgical indications';
    } else if (prediction.predicted_cobb_24m > 25) {
        return 'Consider bracing if progression continues';
    } else {
        return 'Continue observation';
    }
}

// Form validation and user experience improvements
document.addEventListener('DOMContentLoaded', function() {
    // Add real-time risk assessment
    const formInputs = document.querySelectorAll('#predictionForm input, #predictionForm select');
    formInputs.forEach(input => {
        input.addEventListener('change', updateRiskFactors);
    });
});

function updateRiskFactors() {
    // This could show real-time risk factor highlighting
    // Implementation would update the risk factors info panel
}
</script>
{% endblock %}

